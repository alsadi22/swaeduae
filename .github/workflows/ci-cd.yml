name: ci-cd

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none

      - name: Install composer deps
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Prepare test env (sqlite)
        run: |
          cp .env.example .env || true
          php -r "file_put_contents('.env', preg_replace('/^APP_ENV=.*/m','APP_ENV=testing', file_get_contents('.env')));"
          mkdir -p database && : > database/database.sqlite
          {
            echo 'DB_CONNECTION=sqlite'
            echo "DB_DATABASE=$(pwd)/database/database.sqlite"
          } >> .env
          php artisan key:generate

      - name: Lint PHP
        run: find . -type f -name '*.php' -print0 | xargs -0 -n1 -P4 php -l

      - name: Cache & Routes compile
        run: php artisan optimize:clear && php artisan config:cache && php artisan route:cache

      - name: Migrate + basic tests (if any)
        run: |
          php artisan migrate --force
          php artisan test --stop-on-failure || true

  deploy:
    name: deploy
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      PHP_BIN:     ${{ secrets.PHP_BIN }}
      HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Start ssh-agent with deploy key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Make release dir on server
        run: |
          RELEASE=$(date +%Y%m%d%H%M%S)-${{ github.sha }}
          echo "RELEASE=$RELEASE" >> $GITHUB_ENV
          ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} "mkdir -p ${DEPLOY_PATH}/releases/${RELEASE}"

      - name: Rsync source to release
        run: |
          rsync -az --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.env' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/releases/${RELEASE}/

      - name: Remote install & activate
        run: |
          ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} bash -s <<'SSH'
          set -euo pipefail
          APP_DIR="${DEPLOY_PATH}"
          REL_DIR="${DEPLOY_PATH}/releases/${RELEASE}"
          CURRENT="${DEPLOY_PATH}/current"
          PHP="${PHP_BIN:-/usr/bin/php}"
          COMPOSER="$(command -v composer || echo /usr/local/bin/composer)"

          cd "$REL_DIR"

          ln -sfn "$APP_DIR/shared/.env" .env
          rm -rf storage
          ln -sfn "$APP_DIR/shared/storage" storage
          rm -rf bootstrap/cache
          ln -sfn "$APP_DIR/shared/bootstrap/cache" bootstrap/cache

          $PHP $COMPOSER install --no-dev --prefer-dist --no-interaction --optimize-autoloader

          if ! grep -q '^APP_KEY=' "$APP_DIR/shared/.env" || grep -q '^APP_KEY=\s*$' "$APP_DIR/shared/.env"; then
            $PHP artisan key:generate --force
          fi

          $PHP artisan storage:link || true
          $PHP artisan migrate --force
          $PHP artisan optimize:clear
          $PHP artisan config:cache
          $PHP artisan route:cache
          $PHP artisan view:cache || true

          ln -sfn "$REL_DIR" "$CURRENT"

          if command -v sudo >/dev/null; then
            sudo chown -h www-data:www-data "$CURRENT" || true
            sudo chown -R www-data:www-data "$APP_DIR/shared/storage" "$APP_DIR/shared/bootstrap" || true
            command -v systemctl >/dev/null && { sudo systemctl reload php*-fpm || true; sudo systemctl reload nginx || true; }
          fi
SSH

      - name: Healthcheck (optional)
        if: env.HEALTHCHECK_URL != ''
        run: |
          curl -fsSL "${HEALTHCHECK_URL}" -o /dev/null && echo "Health OK" || (echo "Healthcheck failed" && exit 1)
