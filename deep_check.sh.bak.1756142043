#!/usr/bin/env bash
# Deep project checkup v2.1: routes ⇄ controllers ⇄ views + HTTP + middleware
# Non-destructive: only reports, never edits.

set -u
STAMP="$(date +%F-%H%M%S)"
OUT_DIR="tmp/check-$STAMP"
mkdir -p "$OUT_DIR"

say(){ echo -e "$*"; echo -e "$*" >> "$OUT_DIR/summary.txt"; }

say "=== DEEP CHECK v2.1 ($(date)) ==="

# --- PHP syntax check on routes/web.php
if php -l routes/web.php >"$OUT_DIR/routes.lint" 2>&1; then
  say "[OK] routes/web.php syntax clean"
else
  say "[FAIL] routes/web.php has syntax errors"
  cat "$OUT_DIR/routes.lint" >> "$OUT_DIR/summary.txt"
fi

# --- Scan for missing Blade includes/layouts
say "\n--- Blade includes/layouts ---"
grep -R "include" resources/views | grep -E "layouts|partials|components" >> "$OUT_DIR/includes.txt" || true
MISSING=0
for f in resources/views/layouts/app.blade.php \
         resources/views/layouts/guest.blade.php \
         resources/views/partials/navbar.blade.php \
         resources/views/components/lang-toggle.blade.php; do
  [ -f "$f" ] || { say "Missing: $f"; MISSING=1; }
done
[ $MISSING -eq 0 ] && say "All critical layouts/includes present."

# --- Route list & middleware audit
say "\n--- Route middleware audit ---"
php artisan route:list --columns=Method,URI,Name,Middleware \
  | tee "$OUT_DIR/routes.txt" \
  | grep -E '^(GET|POST|PUT|DELETE|PATCH)' >> "$OUT_DIR/summary.txt"

# Flag admin/org routes missing 'auth'
grep -E '/admin|/org' "$OUT_DIR/routes.txt" | grep -v auth >> "$OUT_DIR/summary.txt" || true

# --- Smoke test key endpoints
say "\n--- HTTP smoke test ---"
for url in / /faq /about /contact /opportunities /verify /qr/verify; do
  code=$(curl -sk -o /dev/null -w "%{http_code}" http://127.0.0.1$url)
  say "$url -> $code"
done

say "\nSummary saved to $OUT_DIR/summary.txt"
