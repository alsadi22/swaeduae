<?php
namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;

class SetLocaleAndHeaders
{
    public function handle(Request $request, Closure $next)
    {
        $response = $next($request);

        // Detect locale from app() (you already switch elsewhere). Default to app locale.
        $locale = app()->getLocale() ?: config('app.locale', 'ar');

        // Set Content-Language if not already set.
        if (!$response->headers->has('Content-Language')) {
            $response->headers->set('Content-Language', $locale);
        }

        // Ensure Vary includes Accept-Language (donâ€™t clobber existing values).
        $vary = array_map('trim', explode(',', (string) $response->headers->get('Vary')));
        if (!in_array('Accept-Language', array_map('ucwords', $vary), true)) {
            $vary = array_filter(array_unique(array_merge($vary ?: [], ['Accept-Language'])));
            $response->headers->set('Vary', implode(',', $vary));
        }

        return $response;
    }
}
